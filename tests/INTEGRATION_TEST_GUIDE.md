# 集成测试和功能测试指南

## 概述

本目录包含集成测试和功能测试脚本，用于测试组件间协作和完整的业务流程。

## 测试结构

```
tests/
├── test_integration.gd      # 集成测试：组件协作测试
├── test_functional.gd      # 功能测试：完整业务流程测试
└── test_runner.gd           # 测试运行器（已更新支持新测试）
```

## 集成测试 (test_integration.gd)

### 测试覆盖

1. **组件协作测试**
   - InventoryComponent 和 EquipmentComponent 的协作
   - 物品从背包到装备的流程
   - 组件间的数据传递

2. **物品添加和装备流程**
   - 添加普通物品和装备到背包
   - 从背包装备物品
   - 验证装备状态

3. **物品使用流程**
   - 使用物品（自动装备）
   - 验证使用策略正确执行
   - 验证装备状态更新

4. **背包整理功能**
   - 物品合并
   - 物品排序
   - 槽位优化

5. **信号连接测试**
   - 信号正常发射
   - 信号参数正确
   - 信号监听器正常工作

## 功能测试 (test_functional.gd)

### 测试覆盖

1. **完整的物品管理流程**
   - 多种物品类型的添加
   - 物品堆叠
   - 背包整理
   - 物品数量验证

2. **装备系统完整流程**
   - 单槽位装备（武器）
   - 多槽位装备（戒指）
   - 装备和卸载流程
   - 装备状态验证

3. **物品堆叠和整理**
   - 相同物品自动堆叠
   - 不同物品类型排序
   - 整理后物品位置验证

4. **边界情况测试**
   - 背包满时添加物品
   - 移除不存在的物品
   - 移除超过数量的物品
   - 检查不存在的物品

## 运行测试

### 方法1：在Godot编辑器中运行

1. 打开 `tests/test_main.tscn` 场景
2. 点击运行按钮（F5）
3. 查看输出面板中的测试结果

### 方法2：通过命令行运行

```bash
godot --path . --script tests/test_main.gd
```

## 测试结果解读

### 成功标志

- 所有测试套件显示 "✓ 测试完成"
- 测试总结显示 "成功率: 100%"
- 没有错误或警告信息

### 失败处理

如果测试失败：
1. 查看错误消息，了解失败的测试和原因
2. 检查相关组件的实现
3. 修复问题后重新运行测试

## 测试场景说明

### 场景1：玩家获得新装备

1. 玩家击败敌人，获得装备
2. 装备添加到背包
3. 玩家打开背包，点击装备
4. 装备自动装备到对应槽位
5. 背包中的装备实例移除（或保留，取决于设计）

### 场景2：使用消耗品

1. 玩家拥有生命药水
2. 玩家使用药水
3. 药水数量减少
4. 玩家生命值恢复（需要实现具体策略）

### 场景3：整理背包

1. 背包中有多个相同物品分散在不同槽位
2. 玩家点击整理按钮
3. 相同物品合并
4. 物品按类型排序
5. 空槽位集中在后面

## 注意事项

1. **测试环境**：确保 `ItemManager` 和 `ItemUseStrategyManager` 已作为 AutoLoad 单例初始化
2. **资源注册**：测试中需要手动注册物品类型和装备类型
3. **场景清理**：测试完成后记得清理资源（使用 `queue_free()`）
4. **异步操作**：某些测试需要等待信号处理，使用 `await get_tree().process_frame`

## 扩展测试

### 添加新测试场景

1. 在 `test_integration.gd` 或 `test_functional.gd` 中添加新方法
2. 使用断言函数验证结果
3. 在 `test_integration()` 或 `test_functional()` 中调用新方法

示例：

```gdscript
func test_my_new_scenario() -> void:
    print("    测试我的新场景...")
    
    # 你的测试代码
    assert_true(true, "测试应该通过")
    
    print("    ✓ 我的新场景测试通过")
```

## 相关文档

- [单元测试指南](./README.md)
- [重构计划](../addons/simple_inventory/docs/REFACTORING_PLAN.md)
- [UI架构总结](../addons/simple_inventory/docs/UI_REFACTORING_SUMMARY.md)

